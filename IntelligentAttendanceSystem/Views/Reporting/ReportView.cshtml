@model FaceRecognitionReport

@{
    ViewData["Title"] = "Face Recognition Report";
    Layout = "_Layout";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="fas fa-chart-bar"></i> Face Recognition Report</h4>
                    <div>
                        <button class="btn btn-light btn-sm me-2" onclick="window.print()">
                            <i class="fas fa-print"></i> Print
                        </button>
                        <a href="@Url.Action("Index")" class="btn btn-warning btn-sm">
                            <i class="fas fa-arrow-left"></i> Back
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Report Header -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>Report Period</h5>
                            <p class="mb-1"><strong>From:</strong> @Model.StartDate.ToString("yyyy-MM-dd")</p>
                            <p class="mb-0"><strong>To:</strong> @Model.EndDate.ToString("yyyy-MM-dd")</p>
                        </div>
                        <div class="col-md-6 text-end">
                            <h5>Summary</h5>
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">Total Recognitions</small>
                                    <h4 class="text-primary">@Model.TotalRecognitions</h4>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Unique Users</small>
                                    <h4 class="text-success">@Model.UniqueUsers</h4>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Statistics -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center p-3">
                                    <h3 class="text-primary mb-1">@Model.TotalRecognitions</h3>
                                    <small class="text-muted">Total Recognitions</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center p-3">
                                    <h3 class="text-info mb-1">@Model.TotalDetections</h3>
                                    <small class="text-muted">Total Detections</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center p-3">
                                    <h3 class="text-success mb-1">@Model.UniqueUsers</h3>
                                    <small class="text-muted">Unique Users</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center p-3">
                                    <h3 class="text-warning mb-1">@Model.AverageSimilarity.ToString("F1")%</h3>
                                    <small class="text-muted">Avg. Similarity</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hourly Statistics -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0"><i class="fas fa-clock"></i> Hourly Activity</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Hour</th>
                                                    <th>Recognitions</th>
                                                    <th>Detections</th>
                                                    <th>Total</th>
                                                    <th>Percentage</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var stat in Model.HourlyStats)
                                                {
                                                    var total = stat.Recognitions + stat.Detections;
                                                    var percentage = Model.TotalRecognitions > 0 ? (stat.Recognitions * 100.0 / Model.TotalRecognitions) : 0;
                                                    <tr>
                                                        <td>@stat.Hour:00</td>
                                                        <td>@stat.Recognitions</td>
                                                        <td>@stat.Detections</td>
                                                        <td>@total</td>
                                                        <td>
                                                            <div class="progress" style="height: 20px;">
                                                                <div class="progress-bar" role="progressbar"
                                                                     style="width: @percentage%;"
                                                                     aria-valuenow="@percentage"
                                                                     aria-valuemin="0"
                                                                     aria-valuemax="100">
                                                                    @percentage.ToString("F1")%
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                            <tfoot class="table-secondary">
                                                <tr>
                                                    <td><strong>Total</strong></td>
                                                    <td><strong>@Model.TotalRecognitions</strong></td>
                                                    <td><strong>@Model.TotalDetections</strong></td>
                                                    <td><strong>@(Model.TotalRecognitions + Model.TotalDetections)</strong></td>
                                                    <td><strong>100%</strong></td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Top Users -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0"><i class="fas fa-trophy"></i> Top Users</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Rank</th>
                                                    <th>User Name</th>
                                                    <th>User ID</th>
                                                    <th>Recognition Count</th>
                                                    <th>Average Similarity</th>
                                                    <th>Percentage</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @for (int i = 0; i < Model.TopUsers.Count; i++)
                                                {
                                                    var user = Model.TopUsers[i];
                                                    var percentage = Model.TotalRecognitions > 0 ? (user.RecognitionCount * 100.0 / Model.TotalRecognitions) : 0;
                                                    <tr>
                                                        <td>
                                                            <span class="badge bg-@GetRankBadgeColor(i + 1)">#@(i + 1)</span>
                                                        </td>
                                                        <td>@user.UserName</td>
                                                        <td><code>@user.UserId</code></td>
                                                        <td>@user.RecognitionCount</td>
                                                        <td>
                                                            <span class="badge bg-@GetSimilarityBadgeColor(user.AverageSimilarity)">
                                                                @user.AverageSimilarity.ToString("F1")%
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <div class="progress" style="height: 15px;">
                                                                <div class="progress-bar bg-@GetRankBadgeColor(i + 1)"
                                                                     role="progressbar"
                                                                     style="width: @percentage%;"
                                                                     aria-valuenow="@percentage"
                                                                     aria-valuemin="0"
                                                                     aria-valuemax="100">
                                                                    @percentage.ToString("F1")%
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Department Statistics -->
                    @if (Model.DepartmentStats.Any())
                    {
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0"><i class="fas fa-building"></i> Department Statistics</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-striped">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>Department</th>
                                                        <th>Recognition Count</th>
                                                        <th>User Count</th>
                                                        <th>Avg. Recognitions per User</th>
                                                        <th>Percentage</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var dept in Model.DepartmentStats)
                                                    {
                                                        var avgPerUser = dept.UserCount > 0 ? (dept.RecognitionCount / (double)dept.UserCount) : 0;
                                                        var percentage = Model.TotalRecognitions > 0 ? (dept.RecognitionCount * 100.0 / Model.TotalRecognitions) : 0;
                                                        <tr>
                                                            <td>@dept.Department</td>
                                                            <td>@dept.RecognitionCount</td>
                                                            <td>@dept.UserCount</td>
                                                            <td>@avgPerUser.ToString("F1")</td>
                                                            <td>
                                                                <div class="progress" style="height: 15px;">
                                                                    <div class="progress-bar"
                                                                         role="progressbar"
                                                                         style="width: @percentage%;"
                                                                         aria-valuenow="@percentage"
                                                                         aria-valuemin="0"
                                                                         aria-valuemax="100">
                                                                        @percentage.ToString("F1")%
                                                                    </div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Report Footer -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <small class="text-muted">
                                        Report generated on @DateTime.Now.ToString("yyyy-MM-dd HH:mm") |
                                        Total records processed: @(Model.TotalRecognitions + Model.TotalDetections) |
                                        System: Face Recognition Attendance
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Print functionality
        function printReport() {
            window.print();
        }

        // Export functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Add export buttons to the report view
            const cardHeader = document.querySelector('.card-header');
            const exportDiv = document.createElement('div');
            exportDiv.className = 'btn-group ms-2';
            exportDiv.innerHTML = `
                <button class="btn btn-success btn-sm" onclick="exportReport('excel')">
                    <i class="fas fa-file-excel"></i> Excel
                </button>
                <button class="btn btn-danger btn-sm" onclick="exportReport('pdf')">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
            `;
            cardHeader.querySelector('.d-flex').appendChild(exportDiv);
        });

        async function exportReport(format) {
            const formData = new FormData();
            formData.append('StartDate', '@Model.StartDate.ToString("yyyy-MM-dd")');
            formData.append('EndDate', '@Model.EndDate.ToString("yyyy-MM-dd")');
            formData.append('ReportType', 'custom');
            formData.append('GroupBy', 'day');

            try {
                let url = '';
                if (format === 'excel') {
                    url = '@Url.Action("DownloadExcel", "Reporting")';
                } else if (format === 'pdf') {
                    url = '@Url.Action("DownloadPdf", "Reporting")';
                }

                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;

                    const filename = `face_recognition_report_@Model.StartDate.ToString("yyyyMMdd")_@Model.EndDate.ToString("yyyyMMdd").${format}`;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(downloadUrl);

                    showToast(`Report exported as ${format.toUpperCase()}`, 'success');
                } else {
                    throw new Error('Export failed');
                }
            } catch (error) {
                console.error('Export error:', error);
                showToast('Error exporting report', 'error');
            }
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            // Implementation same as in Index view
            console.log(`${type}: ${message}`);
            alert(`${type.toUpperCase()}: ${message}`); // Simple alert for demo
        }
    </script>
}

@functions {
    string GetRankBadgeColor(int rank)
    {
        return rank switch
        {
            1 => "warning", // Gold
            2 => "secondary", // Silver
            3 => "danger", // Bronze
            _ => "light"
        };
    }

    string GetSimilarityBadgeColor(double similarity)
    {
        return similarity switch
        {
            >= 90 => "success",
            >= 80 => "info",
            >= 70 => "warning",
            _ => "danger"
        };
    }
}